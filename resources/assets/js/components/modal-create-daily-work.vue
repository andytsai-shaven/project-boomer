<template>
    <div class="ui basic modal" v-el:modal>
        <div class="content">
            <form action="#" method="POST" class="ui inverted form" @submit="onSubmit" v-el:form>
                <h4 class="ui inverted dividing header">選擇施工工項</h4>
                <project-flowtype-work-select :project-id.once="projectId"></project-flowtype-work-select>

                <h4 class="ui inverted dividing header">施工部位</h4>
                <div class="field">
                    <input type="text" name="seat">
                </div>

                <h4 class="ui inverted dividing header">選擇協力廠商</h4>
                <div class="field">
                    <subcontractor-select></subcontractor-select>
                </div>

                <button type="submit" class="pm-visibility-hidden"></button>
            </form>
        </div>
        <div class="actions">
            <div class="ui green inverted ok button">
                <i class="checkmark icon"></i>
                送出
            </div>
            <div class="ui inverted cancel button">
                <i class="remove icon"></i>
                取消
            </div>
        </div>
    </div>
</template>

<script type="text/babel">
    import ProjectFlowtypeWorkSelect from './project-flowtype-work-select.vue'
    import SubcontractorSelect from './subcontractor-select.vue'
    import pluck from 'lodash/collection/pluck'
    import zipObject from 'lodash/array/zipObject'

    export default {
        props: ['projectId', 'date', 'onSuccess', 'onCancel'],

        components: { ProjectFlowtypeWorkSelect, SubcontractorSelect },

        methods: {
            openModal() {
                this.$modal.modal('show')
            },
            onSubmit(e) {
                e.preventDefault()

                this.onApprove()

                window.$(this.$els.modal).modal('hide')
            },
            onApprove() {
                const inputs = window.$(this.$els.form).serializeArray()
                const projectId = this.projectId
                const date = this.date

                let values = zipObject(pluck(inputs, 'name'), pluck(inputs, 'value'))
                values['project_work_id'] = values['work_id']

                window.$.post(
                        '/api/v1' +
                        `/projects/${projectId}` +
                        `/construction-dailies/${date}` +
                        '/works',
                        values
                ).then(() => {
                    this.$els.form.reset()

                    if (this.onSuccess) {
                        this.onSuccess()
                    }
                })
            },
            onDeny() {
                this.$els.form.reset()

                if (this.onCancel) {
                    this.onCancel()
                }
            }
        },

        ready() {
            this.$modal = window.$(this.$els.modal).modal({
                closable: false,
                onApprove: this.onApprove,
                onDeny: this.onDeny
            })
        }
    }
</script>
